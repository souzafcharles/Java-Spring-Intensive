# Episode 3: Approval and CORS
## Project Requirements and Configurations:
### 1. Development Profile (Approval Steps):
#### 1.1 Setting up `application-dev.properties` File with PostgreSQL Configurations:
```properties
#spring.jpa.properties.jakarta.persistence.schema-generation.create-source=metadata
#spring.jpa.properties.jakarta.persistence.schema-generation.scripts.action=create
#spring.jpa.properties.jakarta.persistence.schema-generation.scripts.create-target=create.sql
#spring.jpa.properties.hibernate.hbm2ddl.delimiter=;

spring.datasource.url=jdbc:postgresql://localhost:5433/gamelist
spring.datasource.username=postgres
spring.datasource.password=*******

spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true
spring.jpa.hibernate.ddl-auto=none
```
#### 1.2 Configuring Active Profile, CORS, and `application.properties` File for Development:
```properties
spring.profiles.active=${APP_PROFILE:dev}
spring.jpa.open-in-view=false

cors.origins=${CORS_ORIGINS:http://localhost:5173,http://localhost:3000}
```
#### 1.3 Environment Setup with `Docker Compose` for PostgreSQL and pgAdmin/DBeaver:
```yml
version: "37.3.1"
services:
  # ====================================================================================================================
  # POSTGRES SERVER
  # ====================================================================================================================
  pg-docker:
    image: postgres:14-alpine
    container_name: dev-postgresql
    environment:
      POSTGRES_DB: mydatabase
      POSTGRES_PASSWORD: *******
    ports:
      - 5433:5432
    volumes:
      - ./.data/postgresql/data:/var/lib/postgresql/data
    networks:
      - dev-network
  # ====================================================================================================================
  # PGADMIN
  # ====================================================================================================================
  pgadmin-docker:
    image: dpage/pgadmin4
    container_name: dev-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: me@example.com
      PGADMIN_DEFAULT_PASSWORD: *******
    ports:
      - 5050:80
    volumes:
      - ./.data/pgadmin:/var/lib/pgadmin
    depends_on:
      - pg-docker
    networks:
      - dev-network
# ======================================================================================================================
# REDE
# ======================================================================================================================
networks:
  dev-network:
    driver: bridge
```
#### 1.4 Creating project profiles `system.properties`:
```properties
java.runtime.version=21
```
#### 1.5 Generating Database Script delete generated file:
- create.sql:
```sql
create table tb_belonging (position integer, game_id bigint not null, list_id bigint not null, primary key (game_id, list_id));
create table tb_game (game_year integer, score float(53), id bigint generated by default as identity, genre varchar(255), img_url varchar(255), long_description TEXT, platforms varchar(255), short_description TEXT, title varchar(255), primary key (id));
create table tb_game_list (id bigint generated by default as identity, name varchar(255), primary key (id));
alter table if exists tb_belonging add constraint FKrchwdikeu66uky1hf75ym1kh foreign key (list_id) references tb_game_list;
alter table if exists tb_belonging add constraint FK2slybclee7wdfxhfltbvqkgpg foreign key (game_id) references tb_game;
INSERT INTO tb_game_list (name) VALUES ('Adventure and RPG');
INSERT INTO tb_game_list (name) VALUES ('Platform Gaming');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Mass Effect Trilogy', 4.8, 2012, 'Role-playing (RPG), Shooter', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/1.png', 'Embark on an intergalactic adventure filled with choice, consequence, and epic battles.', 'The Mass Effect Trilogy offers a deep narrative-driven RPG experience where every decision you make shapes the fate of the galaxy. Build relationships, engage in strategic combat, and uncover a rich universe teeming with mysteries and conflicts.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Red Dead Redemption 2', 4.7, 2018, 'Role-playing (RPG), Adventure', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/2.png', 'A gripping tale of loyalty and survival in the dying days of the Wild West.', 'Explore a sprawling, immersive world in Red Dead Redemption 2. Experience the life of an outlaw, forge bonds, and navigate moral dilemmas as Arthur Morgan, a member of the notorious Van der Linde gang.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('The Witcher 3: Wild Hunt', 4.7, 2014, 'Role-playing (RPG), Adventure', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/3.png', 'A legendary journey of a monster hunter in a world rife with danger and intrigue.', 'Step into the shoes of Geralt of Rivia, a Witcher, as you hunt monsters, unravel political conspiracies, and make impactful choices in a richly detailed open world.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Sekiro: Shadows Die Twice', 3.8, 2019, 'Role-playing (RPG), Adventure', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/4.png', 'A challenging samurai epic that tests your skills and determination.', 'In Sekiro: Shadows Die Twice, you assume the role of a lone shinobi seeking revenge. Master precise combat mechanics and traverse a visually stunning yet perilous world.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Ghost of Tsushima', 4.6, 2012, 'Role-playing (RPG), Adventure', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/5.png', 'A tale of honor and sacrifice set in feudal Japan.', 'Experience the journey of Jin Sakai, a samurai turned ghost, as he fights to reclaim his homeland from Mongol invaders. Ghost of Tsushima blends breathtaking visuals with an engaging narrative.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Super Mario World', 4.7, 1990, 'Platform', 'Super Ness, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/6.png', 'A timeless classic that redefined platform gaming.', 'Join Mario and Luigi on an epic adventure through Dinosaur Land to rescue Princess Peach from Bowser. Super Mario World features creative level designs and unforgettable gameplay.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Hollow Knight', 4.6, 2017, 'Platform', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/7.png', 'A hauntingly beautiful journey into a mysterious underground world.', 'Hollow Knight offers a challenging yet rewarding metroidvania experience. Discover secrets, face tough enemies, and explore the expansive, interconnected world of Hallownest.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Ori and the Blind Forest', 4, 2015, 'Platform', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/8.png', 'An emotional tale of bravery and friendship in a vibrant forest.', 'Ori and the Blind Forest combines a heartfelt story with visually stunning environments and fluid platforming mechanics. Embark on a journey to restore the forest’s balance.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Cuphead', 4.6, 2017, 'Platform', 'XBox, Playstation, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/9.png', 'A visually striking game inspired by 1930s cartoons.', 'Cuphead challenges players with intense boss battles and creative run-and-gun gameplay, all set against a backdrop of charming, hand-drawn visuals and jazzy music.');
INSERT INTO tb_game (title, score, game_year, genre, platforms, img_url, short_description, long_description) VALUES ('Sonic CD', 4, 1993, 'Platform', 'Sega CD, PC', 'https://github.com/souzafcharles/Java-Spring-Intensive/blob/main/Episode_3_Approval_and_CORS/gamelist/src/main/resources/static/img/10.png', 'A fast-paced adventure through time with Sonic the Hedgehog.', 'In Sonic CD, race through vibrant levels and travel between past, present, and future to thwart Dr. Robotnik’s plans. This classic platformer delivers timeless speed and excitement.');
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (1, 1, 0);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (1, 2, 1);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (1, 3, 2);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (1, 4, 3);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (1, 5, 4);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (2, 6, 0);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (2, 7, 1);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (2, 8, 2);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (2, 9, 3);
INSERT INTO tb_belonging (list_id, game_id, position) VALUES (2, 10, 4);
```
#### 1.6 Configuring CORS with WebConfig Class:
#### 1.6.1 Creating the WebConfig Class:
- Step 1: Annotate the class with @Configuration to indicate it is a Spring configuration class:
```java
@Configuration
public class WebConfig {
}
```
- Step 2: Define a field to hold the CORS origins value from your properties file:
```java
@Value("${cors.origins}")
private String corsOrigins;
```
- Step 3: Create a `WebMvcConfigurer` bean to configure CORS mappings:
```java
@Bean
public WebMvcConfigurer corsConfigurer() {
  return new WebMvcConfigurer() {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
      registry.addMapping("/**").allowedMethods("*").allowedOrigins(corsOrigins);
    }
  };
}
```
- **Complete WebConfig Class**:
```java
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig {

    @Value("${cors.origins}")
    private String corsOrigins;
    
    @Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**").allowedMethods("*").allowedOrigins(corsOrigins);
            }
        };
    }
}
```
#### 1.6.2 Import Statements:
- `@Configuration` Annotation: Marks this class as a configuration class for Spring;
- `@Value Annotation`: Injects the value of cors.origins from application properties;
- `WebMvcConfigurer Bean`: Configures CORS mappings with all methods allowed and origins specified by corsOrigins.
#### 1.7 Run app in `Dev mode` and validate:
- Test app with Postman.
***
### 2. Production Profile (CI/CD Deployment Steps):
#### 2.1 Configuring Environment Variables:
- Define the required environment variables for the application:
```properties
APP_PROFILE
Copy code
DB_URL (Format: jdbc:postgresql://host:port/databasename)
DB_USERNAME
DB_PASSWORD
CORS_ORIGINS
```
#### 2.2 Setting up `application-prod.properties` File with PostgreSQL Configurations:
- Create and configure the `application-prod.properties` file to connect with the PostgreSQL database:
```properties
spring.datasource.url=${DB_URL}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}

spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true
spring.jpa.hibernate.ddl-auto=none
```
#### 2.3 Configuring Active Profile, CORS, and `application.properties` File for Production:
```properties
spring.profiles.active=${APP_PROFILE:prod}
spring.jpa.open-in-view=false

cors.origins=${CORS_ORIGINS:http://localhost:5173,http://localhost:3000}
```
#### 2.4 CI/CD Deployment Steps:
#### 2.3.1 Creating a [Railway](https://railway.app/) account:
- Access Railway and create an account to manage deployment and database services.
#### 2.4.2 Provisioning a Database Server:
- In the Railway dashboard, provision a new PostgreSQL server for the application.
#### 2.4.3 Creating and Seeding the Database:
- Execute SQL scripts to create and populate the database with initial data for the application.
#### 2.4.4 Creating a Railway Application Linked to a GitHub Repository:
- Link the Railway application to a GitHub repository to facilitate continuous deployment.
#### 2.4.5 Configuring Environment Variables in Railway:
- Define the environment variables APP_PROFILE, DB_URL, DB_USERNAME, DB_PASSWORD, and CORS_ORIGINS in the Railway configuration.
#### 2.4.6 Configuring the Public Domain for the Application:
- Set up a public domain or subdomain in Railway to access the application publicly.
#### 2.4.7 Testing the Application with Postman:
- Use Postman to test the application’s APIs and ensure that all functionalities are working correctly.
#### 2.4.8 Testing the CI/CD Pipeline:
- Validate the configured CI/CD pipeline on Railway and GitHub. Ensure that all steps of the build and deployment processes execute as expected.
